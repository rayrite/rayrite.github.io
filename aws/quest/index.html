<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS MCQ Practice - Comprehensive Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        header h1 {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            margin: 0;
        }

        .stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .stats span {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .dataset-selector {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.75rem;
            justify-content: center;
        }

        .dataset-selector label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .dataset-selector select {
            padding: 0.4rem;
            border: none;
            border-radius: 6px;
            background: white;
            color: #333;
            font-size: 0.9rem;
            min-width: 180px;
            max-width: 100%;
        }

        .dataset-selector button {
            padding: 0.4rem 0.8rem;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .dataset-selector button:hover {
            background: #c0392b;
        }

        .tabs {
            display: flex;
            background: #34495e;
            overflow-x: auto;
        }

        .tab-button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: transparent;
            color: #bdc3c7;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Browse Tab Styles */
        .controls {
            display: flex;
            gap: 1rem;
            padding: 0.75rem;
            background: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
        }

        .search-container {
            flex: 2;
            min-width: 200px;
        }

        .filter-container {
            flex: 1;
            min-width: 150px;
        }

        .search-container input,
        .filter-container select {
            width: 100%;
            padding: 0.6rem;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .search-container input:focus,
        .filter-container select:focus {
            outline: none;
            border-color: #3498db;
        }

        .questions-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
            align-content: start;
        }

        .question-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
            transition: all 0.3s ease;
            border-left: 4px solid #3498db;
            height: fit-content;
        }

        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .question-id {
            background: #ff9900;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .question-category {
            background: #f8f9fa;
            color: #495057;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .question-text {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            line-height: 1.6;
            color: #2c3e50;
        }

        .options {
            margin-bottom: 1rem;
        }

        .option {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .option-label {
            font-weight: bold;
            margin-right: 0.75rem;
            color: #ff9900;
            min-width: 25px;
        }

        .option-text {
            flex: 1;
            font-size: 0.9rem;
        }

        .question-actions {
            margin-bottom: 0.75rem;
        }

        .show-answer-btn, .view-table-btn, .see-table-btn {
            background: #ff9900;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .show-answer-btn, .quiz-actions .show-answer-btn {
             background: linear-gradient(135deg, #ff9900, #e6870a);
        }

        .show-answer-btn:hover {
            background: #e6870a;
            transform: translateY(-1px);
        }

        .view-table-btn {
            background: #007bff;
        }

        .view-table-btn:hover {
            background: #0056b3;
        }

        .see-table-btn {
            background: #28a745;
        }

        .see-table-btn:hover {
            background: #218838;
        }
        
        .answer-section {
            background: #f0f9ff;
            border-top: 2px solid #3498db;
            padding: 1.5rem;
            border-radius: 0 0 8px 8px;
            margin-top: -1rem; /* Overlap with quiz actions */
            position: relative;
            z-index: 0;
        }

        .correct-answer {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
        }

        .check-icon {
            background: #28a745;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-size: 0.8rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .answer-content {
            flex: 1;
        }

        .answer-text {
            margin-bottom: 0.5rem;
            color: #155724;
            font-size: 0.9rem;
        }

        .explanation {
            color: #495057;
            font-size: 0.85rem;
            line-height: 1.5;
            background: rgba(255,255,255,0.7);
            padding: 0.75rem;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
        
        .question-number-label {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 0.5rem;
            margin-top: 0.5rem;
        }

        .quiz-question-id-label {
            margin-top: 1rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            font-size: 0.9rem;
            color: #495057;
        }

        /* Quiz Mode Styles */
        .quiz-setup {
            padding: 2rem;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .quiz-setup h3 {
            font-size: 1.8rem;
            margin-bottom: 2rem;
            color: #2c3e50;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            text-align: left;
        }

        .option-group label {
            font-weight: 600;
            color: #34495e;
            font-size: 1rem;
        }

        .option-group select,
        .option-group input[type="text"],
        .option-group input[type="number"] {
            padding: 0.75rem;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .option-group input[type="text"] {
            font-family: inherit;
        }

        .option-group input[type="text"]::placeholder {
            color: #999;
            font-style: italic;
        }

        .start-quiz-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .start-quiz-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }
        
        .start-quiz-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Dataset selection styles */
        .datasets-container {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            padding: 0.75rem;
            background: white;
        }

        .dataset-checkbox-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .dataset-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .dataset-checkbox:hover {
            background-color: #f8f9fa;
        }

        .dataset-checkbox input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }

        .dataset-checkbox label {
            cursor: pointer;
            font-weight: normal;
            font-size: 0.9rem;
            margin: 0;
            flex: 1;
        }

        .dataset-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .dataset-action-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background: white;
            color: #495057;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .dataset-action-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .quiz-container {
            flex: 1;
            display: none; /* Initially hidden */
            flex-direction: column;
            padding: 1rem;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #34495e;
            color: white;
            border-radius: 8px 8px 0 0;
            flex-wrap: wrap;
            gap: 1rem;
        }

        #quizInfo {
            flex-grow: 1;
            text-align: center;
            font-size: 0.8rem;
            color: #bdc3c7;
        }
        
        .quiz-question {
            flex: 1;
            background: white;
            padding: 1.5rem;
            overflow-y: auto;
            border-radius: 0 0 8px 8px;
        }
        
        .quiz-question .question-text {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .quiz-instructions {
            margin: 1rem 0;
            padding: 0.75rem;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }

        .quiz-instructions p {
            margin: 0;
            color: #495057;
            font-size: 0.9rem;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .quiz-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin: 0;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .quiz-option:hover {
            border-color: #ff9900;
            background: #fff9f0;
        }

        .quiz-option.selected {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .quiz-option.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .quiz-option.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .quiz-option input {
            margin-right: 0.75rem;
            transform: scale(1.2);
            cursor: pointer;
        }

        .quiz-option-label {
            font-weight: bold;
            margin-right: 0.75rem;
            color: #000;
            min-width: 25px;
            font-size: 1rem;
        }

        .quiz-option-text {
            flex: 1;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .quiz-result {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-weight: bold;
        }

        .quiz-result.correct {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .quiz-result.incorrect {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result-icon {
            font-size: 1.5em;
            margin-right: 0.5rem;
        }

        .quiz-actions {
            padding: 1rem;
            background: #ecf0f1;
            display: flex;
            gap: 1rem;
            justify-content: center;
            /* border-radius: 0 0 8px 8px; */ /* Removed to connect with answer section */
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .quiz-actions button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .end-quiz-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .next-question-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        /* Score Report Styles */
        .score-report {
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem;
            width: 100%;
        }

        .score-report-header {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .score-report-header h2 {
            color: white;
            margin-bottom: 1.5rem;
            font-size: 2rem;
        }

        .score-summary {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-bottom: 1.5rem;
        }

        .score-stat {
            text-align: center;
        }

        .score-stat-value {
            font-size: 3rem;
            font-weight: bold;
            color: #fff;
            display: block;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .score-stat-label {
            font-size: 1rem;
            color: rgba(255,255,255,0.8);
            margin-top: 0.5rem;
        }

        .score-timestamp {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }

        .score-actions {
            margin-bottom: 2rem;
            text-align: center;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .export-json-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);
        }

        .export-json-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(52, 152, 219, 0.4);
        }

        .back-to-quiz-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(46, 204, 113, 0.3);
        }

        .back-to-quiz-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(46, 204, 113, 0.4);
        }

        .score-report-questions {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .score-report-questions h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #ecf0f1;
        }

        .score-report-question {
            border-bottom: 1px solid #ecf0f1;
            padding: 1.5rem 0;
        }

        .score-report-question:last-child {
            border-bottom: none;
        }

        .score-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .score-question-number {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .score-result-badge {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .score-result-badge.correct {
            background: #d4edda;
            color: #155724;
        }

        .score-result-badge.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .score-question-text {
            font-size: 1.05rem;
            margin-bottom: 1rem;
            color: #2c3e50;
            font-weight: 500;
        }

        .score-user-answer {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #6c757d;
        }

        .score-correct-answer {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: #d4edda;
            border-radius: 6px;
            border-left: 3px solid #28a745;
        }

        .score-explanation {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #e7f3ff;
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }

        .score-label {
            font-weight: bold;
            margin-right: 0.5rem;
            color: #495057;
        }
        
        /* Table Modal Styles */
        .table-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .table-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .table-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #34495e;
            color: white;
        }

        .close-modal-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .table-modal-body {
            flex: 1;
            overflow: auto;
            padding: 1rem;
        }

        .dynamic-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .dynamic-table th,
        .dynamic-table td {
            border: 1px solid #dee2e6;
            padding: 0.75rem;
            text-align: left;
            vertical-align: top;
        }

        .dynamic-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .dynamic-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .table-metadata {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #666;
        }

        .loading, .error, .no-results {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-size: 1rem;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .questions-list { grid-template-columns: 1fr; padding: 0.5rem; }
            .question-card { padding: 1rem; }
            .controls { flex-direction: column; gap: 0.5rem; }
            .search-container, .filter-container { min-width: unset; }
            .quiz-setup { padding: 1rem; }
            .quiz-question { padding: 1rem; }
            .header-top { flex-direction: column; text-align: center; gap: 0.5rem; }
            .stats { justify-content: center; }
            .dataset-selector { flex-direction: column; gap: 0.5rem; }
            .dataset-selector select { min-width: unset; width: 100%; }
            .score-summary { flex-direction: column; gap: 1.5rem; }
            .score-stat-value { font-size: 2.5rem; }
            .score-question-header { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .score-actions { flex-direction: column; }
            .score-report-header { padding: 1.5rem; }
            .score-report-header h2 { font-size: 1.5rem; }
            .quiz-header { flex-direction: column; text-align: center; }
            .datasets-container { max-height: 150px; }
            .quiz-options { max-width: 100%; }
        }

        @media (max-width: 480px) {
            header { padding: 0.4rem; }
            .tab-button { padding: 0.6rem; font-size: 0.85rem; }
            .question-text { font-size: 0.95rem; }
            .stats span { font-size: 0.75rem; padding: 0.25rem 0.6rem; }
            .score-stat-value { font-size: 2rem; }
            .score-report-questions { padding: 1rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1>AWS MCQ Practice</h1>
                <div class="stats">
                    <span id="totalQuestions">Loading...</span>
                    <span id="totalCategories">Loading...</span>
                </div>
            </div>
            <div class="dataset-selector">
                <label for="datasetSelect">Current Dataset (for Browser):</label>
                <select id="datasetSelect"></select>
                <button id="viewTablesBtn" style="display:none;">View Tables</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-button active" data-tab="browse">Question Browser</button>
            <button class="tab-button" data-tab="quiz">Quiz Mode</button>
        </div>

        <div id="browseTab" class="tab-content active">
            <div class="controls">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search questions...">
                </div>
                <div class="filter-container">
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
            </div>
            <div id="questionsList" class="questions-list">
                </div>
        </div>

        <div id="quizTab" class="tab-content">
            <div id="quizSetup" class="quiz-setup">
                <h3>Quiz Setup</h3>
                <div class="quiz-options">
                    <div class="option-group">
                        <label for="quizKeywords">Keywords (comma-separated, optional):</label>
                        <input type="text" id="quizKeywords" placeholder="e.g., S3, DynamoDB, Lambda, storage, compute">
                    </div>
                    
                    <div class="option-group">
                        <label>Select Exam Datasets:</label>
                        <div class="datasets-container">
                            <div class="dataset-checkbox-group" id="datasetCheckboxGroup">
                                </div>
                            <div class="dataset-actions">
                                <button type="button" class="dataset-action-btn" onclick="app.selectAllDatasets()">Select All</button>
                                <button type="button" class="dataset-action-btn" onclick="app.selectNoneDatasets()">Select None</button>
                                <button type="button" class="dataset-action-btn" onclick="app.selectCurrentDataset()">Current Only</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="option-group">
                        <label for="quizCategory">Category:</label>
                        <select id="quizCategory">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    
                    <div class="option-group">
                        <label for="questionCount">Number of Questions:</label>
                        <input type="number" id="questionCount" min="1" max="100" value="10">
                    </div>
                    
                    <div class="option-group">
                        <button id="startQuiz" class="start-quiz-btn">Start Quiz</button>
                    </div>
                </div>
            </div>
            
            <div class="quiz-container" id="quizContainer">
                <div class="quiz-header">
                    <span id="questionNumber">Question 1 of 10</span>
                    <span id="quizInfo"></span>
                    <button id="endQuiz" class="end-quiz-btn">End Quiz</button>
                </div>
                <div class="quiz-question" id="quizQuestion">
                    </div>
                <div class="quiz-actions" id="quizActions">
                     <button id="checkAnswer" class="show-answer-btn">Check Answer</button>
                     <button id="nextQuestion" class="next-question-btn" style="display: none;">Next Question</button>
                </div>
                <div class="answer-section" id="answerSection" style="display: none;">
                    </div>
            </div>
            
            <div id="scoreReport" class="tab-content">
                </div>
        </div>
    </div>

    <div id="tableModal" class="table-modal">
        <div class="table-modal-content">
            <div class="table-modal-header">
                <h3 id="tableModalTitle">Table Data</h3>
                <button id="closeTableModal" class="close-modal-btn">&times;</button>
            </div>
            <div id="tableModalBody" class="table-modal-body">
                </div>
        </div>
    </div>

    <script>
        class MCQApp {
            constructor() {
                this.questions = [];
                this.filteredQuestions = [];
                this.categories = new Set();
                this.currentQuizQuestions = [];
                this.quizResults = [];
                this.currentQuizIndex = 0;
                this.quizInProgress = false;
                this.tablesData = null;
                this.tablesWindow = null;

                this.availableDatasets = [
                    { value: 'aws_mcq_questions.json', label: 'Original Question Bank (1,623 questions)' },
                    { value: 'aws_mock_exams.json', label: 'CLF-C02 Mock Exams (325 questions)' },
                    { value: 'aws_e2_exams.json', label: 'AWS Cloud Practitioner E2 (6e-390 questions)' },
                    { value: 'aws_e3_exams.json', label: 'AWS Cloud Practitioner E3 (3e-195 questions)' },
                    { value: 'aws_e4_exams.json', label: 'AWS Cloud Practitioner E4 (9e-585 questions)' },
                    { value: 'aws_e5_exams.json', label: 'AWS E5 Enhanced (252/252 verified)' },
                    { value: 'aws_e6_exams.json', label: 'AWS E6a ShadingPixel (1e-1000 questions)' },
                    { value: 'aws_e6b_exams.json', label: 'AWS E6b ShadingPixel (1e-425 questions)' },
                    { value: 'aws_e7_exams.json', label: 'AWS E7 Video Mock Exam Rip (1e-65 questions)' },
                    { value: 'aws_e8_exams.json', label: 'AWS E8 SP Weekend Exam Cram (1e-200 questions)' },
                    { value: 'aws_e9_exams.json', label: 'AWS E9 ShadingPixel (1e-1000 questions)' }
                ];
                this.currentDataset = this.availableDatasets[0].value;
                
                this.init();
            }

            async init() {
                try {
                    this.populateDatasetSelect();
                    await this.loadQuestions();
                    await this.loadTablesData();
                    this.setupEventListeners();
                    this.populateCategories();
                    this.populateDatasetCheckboxes();
                    this.renderQuestions();
                    this.updateStats();
                } catch (error) {
                    console.error('Failed to initialize app:', error);
                    this.showError('Failed to load questions. Please refresh the page.');
                }
            }

            populateDatasetSelect() {
                const select = document.getElementById('datasetSelect');
                if (!select) return;
                select.innerHTML = '';
                this.availableDatasets.forEach(ds => {
                    const option = document.createElement('option');
                    option.value = ds.value;
                    option.textContent = ds.label;
                    select.appendChild(option);
                });
                select.value = this.currentDataset;
            }

            async loadTablesData() {
                try {
                    const response = await fetch('aws_mcq_tables.json');
                    if (response?.ok) {
                        this.tablesData = await response.json() ?? [];
                    } else {
                        this.tablesData = [];
                    }
                } catch (error) {
                    console.warn('Error loading tables data:', error);
                    this.tablesData = [];
                }
            }
            
            _processLoadedQuestions(questions) {
                questions.forEach(q => {
                    if (q.answer_letters && q.answer_letters.length > 0) return;

                    const letters = new Set();
                    const correctAnswers = q.correct_answers || [];
                    
                    correctAnswers.forEach(answer => {
                        let match = answer.match(/^([A-Z])\.\s*/) || answer.match(/<b>([A-Z])\.\s*/);
                        if (match) {
                            letters.add(match[1]);
                            return;
                        }
                        
                        answer.split('<br>').forEach(item => {
                            const m = item.trim().match(/^([A-Z])\./);
                            if (m) letters.add(m[1]);
                        });
                        
                        if (letters.size === 0 && q.options) {
                            const cleanAnswer = answer.replace(/<[^>]*>/g, '').trim();
                            q.options.forEach((option, index) => {
                                const cleanOption = option.replace(/<[^>]*>/g, '').trim();
                                if (cleanOption === cleanAnswer) {
                                    letters.add(String.fromCharCode(65 + index));
                                }
                            });
                        }
                    });
                    
                    q.answer_letters = [...letters].sort();
                });
                return questions;
            }

            async loadQuestions() {
                try {
                    const response = await fetch(this.currentDataset);
                    if (!response?.ok) throw new Error(`HTTP error! status: ${response?.status ?? 'unknown'}`);
                    
                    let questions = await response.json() ?? [];
                    this.questions = this._processLoadedQuestions(questions);
                    
                    this.filteredQuestions = [...this.questions];
                    
                    this.categories.clear();
                    this.questions.forEach(q => {
                        if (q?.category) this.categories.add(q.category);
                    });
                } catch (error) {
                    console.error('Error loading questions:', error);
                    throw error;
                }
            }

            async loadMultipleDatasets(datasetFiles) {
                const allQuestions = [];
                for (const datasetFile of datasetFiles) {
                    try {
                        const response = await fetch(datasetFile);
                        if (response?.ok) {
                            let questions = await response.json() ?? [];
                            questions = this._processLoadedQuestions(questions);
                            questions.forEach(q => q.sourceDataset = datasetFile); // Tag source
                            allQuestions.push(...questions);
                        }
                    } catch (error) {
                        console.warn(`Failed to load dataset ${datasetFile}:`, error);
                    }
                }
                return allQuestions;
            }
            
            async switchDataset(newDataset) {
                try {
                    this.currentDataset = newDataset;
                    this.showLoading('browse');
                    await this.loadQuestions();
                    this.resetFilters();
                    this.populateCategories();
                    this.updateDatasetCheckboxes();
                    this.renderQuestions();
                    this.updateStats();
                    this.toggleViewTablesBtn();
                    
                    if (this.quizInProgress) this.endQuiz();
                } catch (error) {
                    console.error('Failed to switch dataset:', error);
                    this.showError('Failed to load the selected dataset. Please try again.', 'browse');
                }
            }

            setupEventListeners() {
                // Main dataset selector
                document.getElementById('datasetSelect')?.addEventListener('change', (e) => {
                    this.switchDataset(e.target.value);
                });

                // Tabs
                document.querySelectorAll('.tab-button')?.forEach(button => {
                    button.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });
                
                // --- BROWSE Tab Listeners ---
                document.getElementById('searchInput')?.addEventListener('input', () => this.filterQuestions());
                document.getElementById('categoryFilter')?.addEventListener('change', () => this.filterQuestions());
                document.getElementById('viewTablesBtn')?.addEventListener('click', () => window.open('aws1600t.html', '_blank'));
                document.getElementById('closeTableModal')?.addEventListener('click', () => this.closeTableModal());
                document.getElementById('tableModal')?.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('tableModal')) this.closeTableModal();
                });

                // --- QUIZ Tab Listeners ---
                document.getElementById('startQuiz')?.addEventListener('click', () => this.startQuiz());
                document.getElementById('endQuiz')?.addEventListener('click', () => this.endQuiz());
                document.getElementById('checkAnswer')?.addEventListener('click', () => this.checkUserAnswer());
                document.getElementById('nextQuestion')?.addEventListener('click', () => this.nextQuizQuestion());

                // Global key listener
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeTableModal();
                });
            }
            
            // --- UI Update & Population ---

            populateCategories() {
                const categoryFilter = document.getElementById('categoryFilter');
                const quizCategory = document.getElementById('quizCategory');
                const sortedCategories = [...this.categories].sort();
                
                const populateSelect = (select) => {
                    if (!select) return;
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">All Categories</option>';
                    sortedCategories.forEach(category => {
                        if (category) {
                            const option = document.createElement('option');
                            option.value = category;
                            option.textContent = category;
                            select.appendChild(option);
                        }
                    });
                    select.value = currentValue;
                };

                populateSelect(categoryFilter);
                populateSelect(quizCategory);
            }
            
            populateDatasetCheckboxes() {
                const container = document.getElementById('datasetCheckboxGroup');
                if (!container) return;
                container.innerHTML = '';
                
                this.availableDatasets.forEach(dataset => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'dataset-checkbox';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="dataset_${dataset.value.replace('.json', '')}" value="${dataset.value}">
                        <label for="dataset_${dataset.value.replace('.json', '')}">${dataset.label}</label>
                    `;
                    container.appendChild(checkboxDiv);
                });
                this.updateDatasetCheckboxes();
            }

            updateDatasetCheckboxes() {
                const checkboxes = document.querySelectorAll('#datasetCheckboxGroup input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = checkbox.value === this.currentDataset;
                });
            }

            updateStats() {
                document.getElementById('totalQuestions').textContent = `${this.questions?.length ?? 0} Questions`;
                document.getElementById('totalCategories').textContent = `${this.categories?.size ?? 0} Categories`;
            }

            toggleViewTablesBtn() {
                const viewTablesBtn = document.getElementById('viewTablesBtn');
                if (viewTablesBtn) {
                    viewTablesBtn.style.display = (this.currentDataset === 'aws_mcq_questions.json') ? 'inline-block' : 'none';
                }
            }

            // --- BROWSE Tab Functionality ---
            
            filterQuestions() {
                const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() ?? '';
                const selectedCategory = document.getElementById('categoryFilter')?.value ?? '';

                this.filteredQuestions = this.questions?.filter(q => {
                    const matchesSearch = !searchTerm || 
                        q.question?.toLowerCase().includes(searchTerm) ||
                        q.options?.some(option => option.toLowerCase().includes(searchTerm));
                    const matchesCategory = !selectedCategory || q.category === selectedCategory;
                    return matchesSearch && matchesCategory;
                }) ?? [];

                this.renderQuestions();
            }
            
            renderQuestions() {
                const questionsList = document.getElementById('questionsList');
                if (!questionsList) return;

                if (!this.filteredQuestions?.length) {
                    questionsList.innerHTML = '<div class="no-results">No questions found.</div>';
                    return;
                }
                questionsList.innerHTML = this.filteredQuestions.map(q => this.createQuestionCard(q)).join('');
            }
            
            createQuestionCard(q) {
                const answerTexts = q.answer_letters.map(letter => {
                    const optionIndex = letter.charCodeAt(0) - 65;
                    return `${letter}. ${q.options?.[optionIndex] || letter}`;
                });
                const correctAnswersDisplay = answerTexts.join('<br>');
                const hasExplanation = q.explanation && q.explanation.trim() !== '';

                const tableControls = this.currentDataset === 'aws_mcq_questions.json' ? `
                    <span class="question-number-label">Q-ID ${q.id ?? 'N/A'}</span>
                    <button class="see-table-btn" onclick="app.showTableForQuestion(${q.id})">See Table</button>
                    <button class="view-table-btn" onclick="app.openTableForQuestion(${q.id})">View Table (New Tab)</button>
                ` : `<span class="question-number-label">Q-ID ${q.id ?? 'N/A'}</span>`;

                return `
                    <div class="question-card">
                        <div class="question-header">
                            <span class="question-id">ID: ${q.id ?? 'N/A'}</span>
                            <span class="question-category">${q.category ?? 'Uncategorized'}</span>
                        </div>
                        <div class="question-text">${q.question ?? ''}</div>
                        <div class="options">
                            ${q.options?.map((option, index) => `
                                <div class="option">
                                    <span class="option-label">${String.fromCharCode(65 + index)})</span>
                                    <span class="option-text">${option ?? ''}</span>
                                </div>`).join('') ?? ''}
                        </div>
                        <div class="question-actions">
                            <button class="show-answer-btn" onclick="app.toggleAnswer(${q.id})">Show Answer</button>
                        </div>
                        <div id="answer-${q.id}" class="correct-answer" style="display: none;">
                            <div class="check-icon">✓</div>
                            <div class="answer-content">
                                <div class="answer-text"><strong>Correct Answer(s):</strong><br>${correctAnswersDisplay}</div>
                                ${hasExplanation ? `<div class="explanation">${q.explanation.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>')}</div>` : ''}
                                ${tableControls}
                            </div>
                        </div>
                    </div>
                `;
            }

            toggleAnswer(questionId) {
                const answerDiv = document.getElementById(`answer-${questionId}`);
                const button = document.querySelector(`button[onclick="app.toggleAnswer(${questionId})"]`);
                if (answerDiv && button) {
                    const isHidden = answerDiv.style.display === 'none';
                    answerDiv.style.display = isHidden ? 'flex' : 'none';
                    button.textContent = isHidden ? 'Hide Answer' : 'Show Answer';
                }
            }

            // --- TABLE Functionality ---

            showTableForQuestion(questionId) {
                if (!this.tablesData || !Array.isArray(this.tablesData)) return alert('Table data not available.');
                const tableEntry = this.tablesData.find(entry => entry.question === questionId.toString());
                if (!tableEntry) return alert(`No table data found for question ${questionId}`);
                this.displayTableModal(tableEntry, questionId);
            }

            displayTableModal(tableEntry, questionId) {
                const modal = document.getElementById('tableModal');
                document.getElementById('tableModalTitle').textContent = `Table for Question ${questionId}`;
                const body = document.getElementById('tableModalBody');
                
                const createTableHTML = (entry) => {
                    let html = '<table class="dynamic-table"><thead><tr>';
                    entry.headers.forEach(h => html += `<th>${h.replace(/\n/g, '<br>')}</th>`);
                    html += '</tr></thead><tbody>';
                    entry.data.forEach(row => {
                        html += '<tr>';
                        row.forEach(cell => html += `<td>${cell.replace(/\n/g, '<br>')}</td>`);
                        html += '</tr>';
                    });
                    return html + '</tbody></table>';
                };
                
                body.innerHTML = createTableHTML(tableEntry);
                if (modal) modal.style.display = 'flex';
            }
            
            closeTableModal() {
                const modal = document.getElementById('tableModal');
                if (modal) modal.style.display = 'none';
            }
            
            openTableForQuestion(questionId) {
                const url = `aws1600t.html#question-${questionId}`;
                if (this.tablesWindow && !this.tablesWindow.closed) {
                    this.tablesWindow.location.href = url;
                    this.tablesWindow.focus();
                } else {
                    this.tablesWindow = window.open(url, 'tablesWindow', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                }
            }

            // --- QUIZ Functionality (Enhanced) ---
            
            selectAllDatasets = () => document.querySelectorAll('#datasetCheckboxGroup input').forEach(cb => cb.checked = true);
            selectNoneDatasets = () => document.querySelectorAll('#datasetCheckboxGroup input').forEach(cb => cb.checked = false);
            selectCurrentDataset = () => this.updateDatasetCheckboxes();
            
            async startQuiz() {
                const startBtn = document.getElementById('startQuiz');
                startBtn.disabled = true;
                startBtn.textContent = 'Loading...';

                try {
                    const keywords = document.getElementById('quizKeywords').value.trim();
                    const selectedCategory = document.getElementById('quizCategory').value;
                    const questionCount = parseInt(document.getElementById('questionCount').value);
                    const selectedDatasets = [...document.querySelectorAll('#datasetCheckboxGroup input:checked')].map(cb => cb.value);

                    if (selectedDatasets.length === 0) {
                        alert('Please select at least one dataset.');
                        return;
                    }

                    let availableQuestions = await this.loadMultipleDatasets(selectedDatasets);

                    if (selectedCategory) {
                        availableQuestions = availableQuestions.filter(q => q.category === selectedCategory);
                    }
                    if (keywords) {
                        const keywordList = keywords.toLowerCase().split(',').map(k => k.trim()).filter(Boolean);
                        availableQuestions = availableQuestions.filter(q => {
                            const searchText = `${q.question} ${q.options.join(' ')}`.toLowerCase();
                            return keywordList.some(kw => searchText.includes(kw));
                        });
                    }

                    if (!availableQuestions.length) {
                        alert('No questions found matching your criteria.');
                        return;
                    }

                    this.currentQuizQuestions = this.shuffleArray(availableQuestions).slice(0, questionCount);
                    if (this.currentQuizQuestions.length === 0) {
                         alert('No questions found after filtering and slicing.');
                         return;
                    }
                    this.currentQuizIndex = 0;
                    this.quizInProgress = true;
                    this.quizResults = [];

                    // **** ADDED THIS BLOCK ****
                    const quizInfo = document.getElementById('quizInfo');
                    if (quizInfo) {
                        const datasetNames = selectedDatasets.map(ds => {
                            const dataset = this.availableDatasets.find(d => d.value === ds);
                            return dataset ? dataset.label.split(' (')[0].trim() : ds;
                        });
                        let infoText = `Sources: ${datasetNames.join(', ')}`;
                        if (keywords) infoText += ` | Keywords: ${keywords}`;
                        if (selectedCategory) infoText += ` | Category: ${selectedCategory}`;
                        quizInfo.textContent = infoText;
                    }
                    // **** END OF ADDED BLOCK ****

                    document.getElementById('quizSetup').style.display = 'none';
                    document.getElementById('quizContainer').style.display = 'flex';
                    document.getElementById('scoreReport').classList.remove('active');

                    this.displayCurrentQuizQuestion();
                } catch (error) {
                    console.error("Failed to start quiz:", error);
                    alert("An error occurred while starting the quiz.");
                } finally {
                    startBtn.disabled = false;
                    startBtn.textContent = 'Start Quiz';
                }
            }
            
            displayCurrentQuizQuestion() {
                const question = this.currentQuizQuestions[this.currentQuizIndex];
                if (!question) return;

                document.getElementById('questionNumber').textContent = `Question ${this.currentQuizIndex + 1} of ${this.currentQuizQuestions.length}`;
                
                const isMultiple = question.answer_letters.length > 1;
                const inputType = isMultiple ? 'checkbox' : 'radio';
                const instructions = isMultiple ? `Select ${question.answer_letters.length} answers:` : 'Select one answer:';
                
                document.getElementById('quizQuestion').innerHTML = `
                    <div class="question-text">${question.question}</div>
                    <div class="quiz-instructions"><p><strong>${instructions}</strong></p></div>
                    <div class="quiz-options">
                        ${question.options.map((option, index) => {
                            const letter = String.fromCharCode(65 + index);
                            return `
                                <div class="quiz-option" onclick="app.toggleQuizOption(this, '${inputType}')">
                                    <input type="${inputType}" id="option-${letter}" name="quiz-answer" value="${letter}">
                                    <span class="quiz-option-label">${letter}.</span>
                                    <span class="quiz-option-text">${option}</span>
                                </div>`;
                        }).join('')}
                    </div>
                `;
                
                // Reset actions UI
                document.getElementById('answerSection').style.display = 'none';
                document.getElementById('checkAnswer').style.display = 'inline-block';
                document.getElementById('nextQuestion').style.display = 'none';
            }

            toggleQuizOption(optionDiv, inputType) {
                const input = optionDiv.querySelector('input');
                if (input.disabled) return;
                
                if (inputType === 'radio') {
                    document.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
                    input.checked = true;
                    optionDiv.classList.add('selected');
                } else {
                    input.checked = !input.checked;
                    optionDiv.classList.toggle('selected', input.checked);
                }
            }

            checkUserAnswer() {
                const question = this.currentQuizQuestions[this.currentQuizIndex];
                const selectedInputs = [...document.querySelectorAll('.quiz-option input:checked')];
                const userAnswers = selectedInputs.map(input => input.value).sort();
                const correctAnswers = question.answer_letters.sort();

                if (userAnswers.length === 0) return alert('Please select an answer.');

                const isCorrect = JSON.stringify(userAnswers) === JSON.stringify(correctAnswers);
                this.quizResults.push({ question, userAnswers, correctAnswers, isCorrect });

                // Visual feedback on options
                document.querySelectorAll('.quiz-option').forEach(optionDiv => {
                    const input = optionDiv.querySelector('input');
                    input.disabled = true; // Disable further clicks
                    if (correctAnswers.includes(input.value)) {
                        optionDiv.classList.add('correct');
                    } else if (input.checked) {
                        optionDiv.classList.add('incorrect');
                    }
                });

                // Display the answer section
                this.showCurrentAnswer(isCorrect, userAnswers, correctAnswers);
                
                // Update action buttons
                document.getElementById('checkAnswer').style.display = 'none';
                document.getElementById('nextQuestion').style.display = 'inline-block';
            }
            
            showCurrentAnswer(isCorrect, userAnswers, correctAnswers) {
                const question = this.currentQuizQuestions[this.currentQuizIndex];
                const answerSection = document.getElementById('answerSection');
                
                const resultMessage = isCorrect ? 'Correct!' : 'Incorrect';
                const resultClass = isCorrect ? 'correct' : 'incorrect';

                const correctAnswersDisplay = question.answer_letters.map(letter => {
                    const optionIndex = letter.charCodeAt(0) - 65;
                    return `${letter}. ${question.options[optionIndex]}`;
                }).join('<br>');

                answerSection.innerHTML = `
                    <div class="quiz-result ${resultClass}">
                        <span class="result-icon">${isCorrect ? '✓' : '✗'}</span>
                        ${resultMessage}
                    </div>
                    <div class="correct-answer">
                        <div class="check-icon">✓</div>
                        <div class="answer-content">
                            <div class="answer-text">
                                <strong>Correct Answer(s):</strong><br><span id="correctAnswerText">${correctAnswersDisplay}</span>
                            </div>
                            <div id="explanationText" class="explanation" style="${question.explanation ? '' : 'display:none;'}">
                                ${question.explanation || ''}
                            </div>
                        </div>
                    </div>
                `;
                answerSection.style.display = 'block';
            }
            
            nextQuizQuestion() {
                this.currentQuizIndex++;
                if (this.currentQuizIndex >= this.currentQuizQuestions.length) {
                    this.showScoreReport();
                } else {
                    this.displayCurrentQuizQuestion();
                }
            }
            
            endQuiz() {
                this.quizInProgress = false;
                this.currentQuizQuestions = [];
                this.quizResults = [];
                this.currentQuizIndex = 0;

                document.getElementById('quizSetup').style.display = 'flex';
                document.getElementById('quizContainer').style.display = 'none';
                document.getElementById('scoreReport').classList.remove('active');
            }

            showScoreReport() {
                document.getElementById('quizContainer').style.display = 'none';
                const scoreReportDiv = document.getElementById('scoreReport');
                
                const total = this.quizResults.length;
                const correct = this.quizResults.filter(r => r.isCorrect).length;
                const score = total > 0 ? Math.round((correct / total) * 100) : 0;

                const resultsHTML = this.quizResults.map((result, index) => {
                    const q = result.question;
                    const userAnswerText = result.userAnswers.map(l => `${l}. ${q.options[l.charCodeAt(0)-65]}`).join('<br>');
                    const correctAnswerText = result.correctAnswers.map(l => `${l}. ${q.options[l.charCodeAt(0)-65]}`).join('<br>');
                    return `
                        <div class="score-report-question">
                            <div class="score-question-header">
                                <span class="score-question-number">Question ${index + 1} (ID: ${q.id})</span>
                                <span class="score-result-badge ${result.isCorrect ? 'correct' : 'incorrect'}">${result.isCorrect ? 'Correct' : 'Incorrect'}</span>
                            </div>
                            <div class="score-question-text">${q.question}</div>
                            <div class="score-user-answer"><span class="score-label">Your Answer:</span><br>${userAnswerText}</div>
                            ${!result.isCorrect ? `<div class="score-correct-answer"><span class="score-label">Correct Answer:</span><br>${correctAnswerText}</div>` : ''}
                            ${q.explanation ? `<div class="score-explanation"><span class="score-label">Explanation:</span> ${q.explanation}</div>` : ''}
                        </div>
                    `;
                }).join('');

                scoreReportDiv.innerHTML = `
                    <div class="score-report">
                        <div class="score-report-header">
                            <h2>Quiz Results</h2>
                            <div class="score-summary">
                                <div class="score-stat"><span class="score-stat-value">${score}%</span><span class="score-stat-label">Score</span></div>
                                <div class="score-stat"><span class="score-stat-value">${correct}/${total}</span><span class="score-stat-label">Correct</span></div>
                            </div>
                            <div class="score-timestamp">Completed: ${new Date().toLocaleString()}</div>
                        </div>
                        <div class="score-actions">
                            <button class="export-json-btn" onclick="app.exportScoreReport()">Export to JSON</button>
                            <button class="back-to-quiz-btn" onclick="app.endQuiz()">New Quiz</button>
                        </div>
                        <div class="score-report-questions"><h3>Question Review</h3>${resultsHTML}</div>
                    </div>
                `;
                scoreReportDiv.classList.add('active');
            }

            exportScoreReport() {
                const exportData = {
                    timestamp: new Date().toISOString(),
                    results: this.quizResults.map(r => ({
                        questionId: r.question.id,
                        questionText: r.question.question,
                        userAnswers: r.userAnswers,
                        correctAnswers: r.correctAnswers,
                        isCorrect: r.isCorrect,
                    }))
                };
                const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(exportData, null, 2));
                const dl = document.createElement('a');
                dl.setAttribute('href', dataStr);
                dl.setAttribute('download', `quiz-results-${new Date().toISOString()}.json`);
                document.body.appendChild(dl);
                dl.click();
                dl.remove();
            }

            // --- Generic Helpers ---
            switchTab(tabName) {
                document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`${tabName}Tab`).classList.add('active');
                
                if (tabName === 'quiz') {
                    this.endQuiz(); // Reset quiz state when switching to quiz tab
                }
            }

            resetFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('categoryFilter').value = '';
                this.filteredQuestions = [...this.questions];
            }

            showLoading(tab) {
                if (tab === 'browse') {
                    document.getElementById('questionsList').innerHTML = '<div class="loading">Loading...</div>';
                }
            }

            showError(message, tab) {
                if (tab === 'browse') {
                    document.getElementById('questionsList').innerHTML = `<div class="error">${message}</div>`;
                }
            }
            
            shuffleArray = (array) => array.map(value => ({ value, sort: Math.random() })).sort((a, b) => a.sort - b.sort).map(({ value }) => value);
        }

        // Initialize the app
        const app = new MCQApp();
    </script>
</body>
</html>